name: Awesome-notes actions

on:
  push:
    branches:
      - main
      - dev 
  pull_request:
    branches:
      - main

jobs:
  services-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test services
      run: |
          echo Testing auth_service....
          cd auth_service/ && python3 -m pip install -r requirements.txt && python3 -m pytest
          echo Testing user_service....
          cd ../user_service/ && python3 -m pip install -r requirements.txt && python3 -m pytest
          echo Testing notes_service....
          cd ../notes_service/ && python3 -m pip install -r requirements.txt && python3 -m pytest
    
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: development

    steps:
      - uses: actions/checkout@v4.2.2

      - name: Construction services`s .env files
        run: | 
          # auth_service development.env construction
          cat > auth_service/config/development.env <<EOF
          POSTGRES_USER=${{secrets.DEV_AUTH_POSTGRES_USER}}
          POSTGRES_PASSWORD=${{secrets.DEV_AUTH_POSTGRES_PASSWORD}}
          POSTGRES_DB=${{secrets.DEV_AUTH_POSTGRES_DB}}

          RABBITMQ_USER=${{secrets.DEV_AUTH_RABBITMQ_USER}}
          RABBITMQ_PASSWORD=${{secrets.DEV_AUTH_RABBITMQ_PASSWORD}}
    
          REDIS_USER=${{secrets.DEV_AUTH_REDIS_USER}}
          REDIS_USER_PASSWORD=${{secrets.DEV_AUTH_REDIS_USER_PASSWORD}}
          REDIS_PASSWORD=${{secrets.DEV_AUTH_REDIS_PASSWORD}}

          ALGORITHM=${{secrets.DEV_AUTH_ALGORITHM}}
          SECRET_KEY=${{secrets.DEV_AUTH_SECRET_KEY}}
          EOF
          echo user_service/config/development.env has created successfully

          # user_service development.env construction
          cat > user_service/config/development.env <<EOF
          POSTGRES_USER=${{secrets.DEV_USER_POSTGRES_USER}}
          POSTGRES_PASSWORD=${{secrets.DEV_USER_POSTGRES_PASSWORD}}
          POSTGRES_DB=${{secrets.DEV_USER_POSTGRES_DB}}
    
          RABBITMQ_USER=${{secrets.DEV_USER_RABBITMQ_USER}}
          RABBITMQ_PASSWORD=${{secrets.DEV_USER_RABBITMQ_PASSWORD}}
          EOF
          echo user_service/config/development.env has created successfully

          # notes_service development.env construction
          cat > notes_service/config/development.env <<EOF
          POSTGRES_USER=${{secrets.DEV_NOTES_POSTGRES_USER}}
          POSTGRES_PASSWORD=${{secrets.DEV_NOTES_POSTGRES_PASSWORD}}
          POSTGRES_DB=${{secrets.DEV_NOTES_POSTGRES_DB}}
    
          RABBITMQ_USER=${{secrets.DEV_NOTES_RABBITMQ_USER}}
          RABBITMQ_PASSWORD=${{secrets.DEV_NOTES_RABBITMQ_PASSWORD}}
          EOF
          echo notes_service/config/development.env has created successfully

          cat > config/development.env <<EOF
          ENVIRONMENT=development
          RABBITMQ_DEFAULT_USER=${{secrets.DEV_AUTH_RABBITMQ_USER}}
          RABBITMQ_DEFAULT_PASS=${{secrets.DEV_AUTH_RABBITMQ_PASSWORD}}
          REDIS_USER=${{secrets.DEV_AUTH_REDIS_USER}}
          REDIS_USER_PASSWORD=${{secrets.DEV_AUTH_REDIS_USER_PASSWORD}}
          REDIS_PASSWORD=${{secrets.DEV_AUTH_REDIS_PASSWORD}}
          EOF
          echo config/development.env has created successfully
      - name: Validate .env files
        run: |
          # Check for missing required variables auth_service/.env
          if [ ! -f auth_service/config/development.env ]; then
            echo "Env file auth_service/config/development.env is missing"
            exit 1
          fi
          AUTH_REQUIRED_VARS=("POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB RABBITMQ_USER RABBITMQ_PASSWORD REDIS_USER REDIS_USER_PASSWORD REDIS_PASSWORD ALGORITHM SECRET_KEY") 
          for var in $AUTH_REQUIRED_VARS; do
            if ! grep -qE "^$var=.+$" auth_service/config/development.env; then
              echo "Error: Missing required variable $var in auth_service/config/development.env"
              exit 1
            fi
          done


          # Check for missing required variables user_service/config/development.env
          if [ ! -f user_service/config/development.env ]; then
            echo "Env file user_service/config/development.env is missing"
            exit 1
          fi
          USER_REQUIRED_VARS=("POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB RABBITMQ_USER RABBITMQ_PASSWORD") 
          for var in $USER_REQUIRED_VARS; do
            if ! grep -qE "^$var=.+$" user_service/config/development.env; then
              echo "Error: Missing required variable $var in user_service/config/development.env"
              exit 1
            fi
          done

          # Check for missing required variables notes_service/config/development.env
          if [ ! -f notes_service/config/development.env ]; then
            echo "Env file notes_service/config/development.env is missing"
            exit 1
          fi
          NOTES_REQUIRED_VARS=("POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB RABBITMQ_USER RABBITMQ_PASSWORD") 
          for var in $NOTES_REQUIRED_VARS; do
            if ! grep -qE "^$var=.+$" notes_service/config/development.env; then
              echo "Error: Missing required variable $var in notes_service/config/development.env"
              exit 1
            fi
          done
          
          # Check for missing required variables config/development.env
          if [ ! -f config/development.env ]; then
            echo "Env file config/development.env is missing"
            exit 1
          fi
          GLOBAL_REQUIRED_VARS=("RABBITMQ_DEFAULT_USER RABBITMQ_DEFAULT_PASS REDIS_USER REDIS_USER_PASSWORD REDIS_PASSWORD") 
          for var in $GLOBAL_REQUIRED_VARS; do
            if ! grep -qE "^$var=.+$" config/development.env; then
              echo "Error: Missing required variable $var in config/development.env"
              exit 1
            fi
          done
      - name: Set up docker compose
        uses: docker/setup-compose-action@v1
        
      - name: Run docker compose directly
        run: |
            cat ./config/development.env
            docker compose --env-file ./config/development.env up --build -d

            docker container ls
            
            echo auth env
            docker compose exec auth-service-http /bin/sh env
            echo user env 
            docker compose exec user-service-http /bin/sh env
            echo notes env 
            docker compose exec notes-service-http /bin/sh env

